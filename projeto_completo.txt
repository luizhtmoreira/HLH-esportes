==> banco.c <==
#include <stdio.h>
#include <stdlib.h>
#include <string.h>

#include "sqlite3.h"
#include "banco.h"
#include "produto.h"
#include "cliente.h"

#define DB_NAME "loja_database.db"

void inicializar_banco(){
    sqlite3 *db;
    char *erro = 0;
    int rc = sqlite3_open(DB_NAME, &db);

    if (rc){
        printf("Erro ao abrir banco: %s\n", sqlite3_errmsg(db));
        return;
    }

    char *sql_vendas = "CREATE TABLE IF NOT EXISTS vendas ("
                "id INTEGER PRIMARY KEY AUTOINCREMENT, "
                "cpf_cliente TEXT NOT NULL, "
                "nome_cliente TEXT NOT NULL, "
                "produto_nome TEXT NOT NULL, "
                "qtd INTEGER, "
                "total REAL, "
                "data_hora DATETIME DEFAULT CURRENT_TIMESTAMP);";
    sqlite3_exec(db, sql_vendas, 0, 0, &erro);

    char *sql_prod = "CREATE TABLE IF NOT EXISTS produtos ("
                     "codigo INTEGER PRIMARY KEY, "
                     "nome TEXT, preco REAL, qtd INTEGER, categoria INTEGER);";
    sqlite3_exec(db, sql_prod, 0, 0, &erro);

    char *sql_cli = "CREATE TABLE IF NOT EXISTS clientes ("
                    "cpf TEXT PRIMARY KEY, nome TEXT, email TEXT, "
                    "telefone TEXT, nascimento TEXT);";
    sqlite3_exec(db, sql_cli, 0, 0, &erro);

    sqlite3_close(db);
}

void salvar_venda_sql(char *cpf, char *nome_cliente, produto* carrinho){
    sqlite3 *db;
    char *erro = 0;
    sqlite3_open(DB_NAME, &db);

    produto *p = carrinho;
    char sql[500];

    sqlite3_exec(db, "BEGIN TRANSACTION;", 0, 0, 0);

    while (p != NULL){
        float total_item = p->preco * p->quantidade;
        sprintf(sql, "INSERT INTO vendas (cpf_cliente, nome_cliente, produto_nome, qtd, total) "
                     "VALUES ('%s', '%s', '%s', %d, %.2f);",
                     cpf, nome_cliente, p->nome, p->quantidade, total_item);

        int rc = sqlite3_exec(db, sql, 0, 0, &erro);

        if (rc != SQLITE_OK) {
            printf("Erro ao salvar item %s: %s\n", p->nome, erro);
            sqlite3_free(erro);
        }

        p = p->prox;
    }
    sqlite3_exec(db, "COMMIT;", 0, 0, 0);
    printf("Venda registrada no Banco de Dados com sucesso!\n");
    sqlite3_close(db);
}

void imprimir_linha_sql(sqlite3_stmt *res) {
    
    const unsigned char *data = sqlite3_column_text(res, 6);
    const unsigned char *prod = sqlite3_column_text(res, 3);
    const unsigned char *cliente = sqlite3_column_text(res, 2);
    int qtd = sqlite3_column_int(res, 4);
    double total = sqlite3_column_double(res, 5);

    if (cliente != NULL){
        printf("[%s] %s comprou %dx %s (R$ %.2f)\n", data, cliente, qtd, prod, total);
    } else {
        printf("[%s] %dx %s (R$ %.2f)\n", data, qtd, prod, total);
    }
}

void listar_historico_geral_sql(){
    sqlite3 *db;
    sqlite3_stmt *res;

    sqlite3_open(DB_NAME, &db);

    char *sql = "SELECT * FROM vendas ORDER BY id DESC;";

    int rc = sqlite3_prepare_v2(db, sql, -1, &res, 0);

    if (rc != SQLITE_OK) {
        printf("Erro ao buscar dados: %s\n", sqlite3_errmsg(db));
        sqlite3_close(db);
        return;
    }

    printf("\n=== HISTORICO GERAL DE VENDAS ===\n");
    
    int encontrou = 0;
    while (sqlite3_step(res) == SQLITE_ROW) {
        imprimir_linha_sql(res);
        encontrou = 1;
    }

    if (!encontrou) printf("Nenhuma venda registrada no sistema.\n");
    printf("==========================================\n");

    sqlite3_finalize(res); 
    sqlite3_close(db);
}

void listar_historico_cliente_sql(char *cpf_busca){
    sqlite3 *db;
    sqlite3_stmt *res;

    sqlite3_open(DB_NAME, &db);

    char *sql = "SELECT * FROM vendas WHERE cpf_cliente = ? ORDER BY id DESC;";

    sqlite3_prepare_v2(db, sql, -1, &res, 0);
    sqlite3_bind_text(res, 1, cpf_busca, -1, SQLITE_STATIC);

    printf("\n=== HISTORICO DO CLIENTE %s ===\n", cpf_busca);

    while (sqlite3_step(res) == SQLITE_ROW) {
        imprimir_linha_sql(res); 
    }

    sqlite3_finalize(res); 
    sqlite3_close(db);

}

void salvar_produto_sql(produto *p){
    sqlite3 *db;
    char sql[300];
    sqlite3_open(DB_NAME, &db);
    sprintf(sql, "INSERT INTO produtos VALUES (%d, '%s', %.2f, %d, %d);",
            p->codigo, p->nome, p->preco, p->quantidade, p->categoria);
    sqlite3_exec(db, sql, 0, 0, 0);
    sqlite3_close(db);
}

void atualizar_produto_sql(produto *p, int codigo_original) {
    sqlite3 *db;
    char sql[300];
    sqlite3_open(DB_NAME, &db);
    
    sprintf(sql, "UPDATE produtos SET codigo=%d, nome='%s', preco=%.2f, qtd=%d, categoria=%d WHERE codigo=%d;",
            p->codigo, p->nome, p->preco, p->quantidade, p->categoria, codigo_original);
            
    sqlite3_exec(db, sql, 0, 0, 0);
    sqlite3_close(db);
}

void remover_produto_sql(int codigo) {
    sqlite3 *db;
    char sql[100];
    sqlite3_open(DB_NAME, &db);
    sprintf(sql, "DELETE FROM produtos WHERE codigo=%d;", codigo);
    sqlite3_exec(db, sql, 0, 0, 0);
    sqlite3_close(db);
}

produto* carregar_produtos_do_sql() {
    sqlite3 *db;
    sqlite3_stmt *res;
    sqlite3_open(DB_NAME, &db);
    
    if(sqlite3_prepare_v2(db, "SELECT * FROM produtos;", -1, &res, 0) != SQLITE_OK){
        sqlite3_close(db); return NULL;
    }

    produto *lista = NULL; 

    while (sqlite3_step(res) == SQLITE_ROW) {
        produto *novo = (produto*) malloc(sizeof(produto));
        novo->codigo = sqlite3_column_int(res, 0);
        strcpy(novo->nome, (char*)sqlite3_column_text(res, 1));
        novo->preco = sqlite3_column_double(res, 2);
        novo->quantidade = sqlite3_column_int(res, 3);
        novo->categoria = sqlite3_column_int(res, 4);
        novo->prox = lista;
        lista = novo;
    }
    sqlite3_finalize(res);
    sqlite3_close(db);
    return lista;
}

void salvar_cliente_sql(cliente *c) {
    sqlite3 *db;
    char sql[500];
    sqlite3_open(DB_NAME, &db);
    sprintf(sql, "INSERT INTO clientes VALUES ('%s', '%s', '%s', '%s', '%s');",
            c->CPF, c->nome, c->email, c->telefone, c->data_de_nascimento);
    sqlite3_exec(db, sql, 0, 0, 0);
    sqlite3_close(db);
}

void atualizar_cliente_sql(cliente *c, char *cpf_original) {
    sqlite3 *db;
    char sql[500];
    sqlite3_open(DB_NAME, &db);
    
    sprintf(sql, "UPDATE clientes SET cpf='%s', nome='%s', email='%s', telefone='%s', nascimento='%s' WHERE cpf='%s';",
            c->CPF, c->nome, c->email, c->telefone, c->data_de_nascimento, cpf_original);
            
    sqlite3_exec(db, sql, 0, 0, 0);
    sqlite3_close(db);
}

void remover_cliente_sql(char *cpf) {
    sqlite3 *db;
    char sql[200];
    sqlite3_open(DB_NAME, &db);
    sprintf(sql, "DELETE FROM clientes WHERE cpf='%s';", cpf);
    sqlite3_exec(db, sql, 0, 0, 0);
    sqlite3_close(db);
}

cliente* carregar_clientes_do_sql() {
    sqlite3 *db;
    sqlite3_stmt *res;
    sqlite3_open(DB_NAME, &db);

    if(sqlite3_prepare_v2(db, "SELECT * FROM clientes;", -1, &res, 0) != SQLITE_OK){
        sqlite3_close(db); return NULL;
    }

    cliente *lista = NULL;

    while (sqlite3_step(res) == SQLITE_ROW) {
        cliente *novo = (cliente*) malloc(sizeof(cliente));
        strcpy(novo->CPF, (char*)sqlite3_column_text(res, 0));
        strcpy(novo->nome, (char*)sqlite3_column_text(res, 1));
        strcpy(novo->email, (char*)sqlite3_column_text(res, 2));
        strcpy(novo->telefone, (char*)sqlite3_column_text(res, 3));
        strcpy(novo->data_de_nascimento, (char*)sqlite3_column_text(res, 4));
        
        novo->carrinho = NULL;
        novo->prox = lista;
        lista = novo;
    }
    sqlite3_finalize(res);
    sqlite3_close(db);
    return lista;
}





==> banco.h <==
#ifndef BANCO_H
#define BANCO_H

#include "produto.h"


void inicializar_banco();

void salvar_venda_sql(char *cpf, char *nome_cliente, produto *carrinho);
void listar_historico_geral_sql();
void listar_historico_cliente_sql(char *cpf_busca);

produto* carregar_produtos_do_sql();
void salvar_produto_sql(produto *p);
void atualizar_produto_sql(produto *p, int codigo_original);
void remover_produto_sql(int codigo);

cliente* carregar_clientes_do_sql();
void salvar_cliente_sql(cliente *c);
void atualizar_cliente_sql(cliente *c, char *cpf_original);
void remover_cliente_sql(char *cpf);

#endif
==> cliente.c <==
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <ctype.h>

#include "cliente.h"
#include "produto.h"
#include "banco.h"

void menu_clientes(cliente **inicio){
    int opcao;
    do {
        printf("\n=== MENU CLIENTES ===\n");
        printf("1. Cadastrar Novo\n");
        printf("2. Listar Todos\n");
        printf("3. Buscar por CPF\n");
        printf("4. Editar Cliente\n");
        printf("5. Remover Cliente\n");
        printf("6. Ver histórico de cliente\n");
        printf("0. Voltar\n");
        printf("Escolha: ");
        scanf("%d", &opcao);

        switch(opcao) {
            case 1: 
                cadastrar_cliente(inicio);
                break;
            case 2: 
                listar_clientes(*inicio);
                break;
            case 3: 
                {
                    char cpf[14];
                    printf("CPF: ");
                    scanf(" %[^\n]", cpf);
                    cliente *res = buscar_cliente(*inicio, cpf);
                    if(res) printf("Encontrado: %s\n", res->nome);
                    else printf("Nao encontrado.\n");
                }
                break;
            case 4:
                editar_cliente(*inicio);
                break;
            case 5:
                remover_cliente(inicio);
                break;
            case 6:
            {
                char cpf_busca[15];
                printf("Digite o CPF do cliente para ver o histórico: ");
                scanf(" %[^\n]", cpf_busca);
                listar_historico_cliente_sql(cpf_busca);
            }
            break;
                
            case 0:
                break;
            default:
                printf("Opcao invalida!\n");
        }
    } while (opcao != 0);
}

int validar_cpf(char *cpf){
    if (strlen(cpf) != 11){
        return 0;
    }

    for (int i = 0; i < 11; i++){
        if (!isdigit(cpf[i])){
            return 0;
        }
    }
    return 1;
}

int validar_telefone(char *telefone){
    int tam = strlen(telefone);
    if (strlen(telefone) != 11 && strlen(telefone) != 10){
        return 0;
    }

    for (int i = 0; i < tam; i++){
        if (!isdigit(telefone[i])){
            return 0;
        }
    }
    return 1;
}

int validar_data(char *data){
    if (strlen(data) != 10){
        return 0;
    }

    if (data[2] != '/' || data[5] != '/'){
        return 0;
    }

    for (int i = 0; i < 10; i++){
        if (i == 2 || i == 5){
            continue;
        }

        if (!isdigit(data[i])){
            return 0;
        }
    }
    return 1;
}


cliente* criar_cliente(){
    cliente *novo_cliente = (cliente*) malloc(sizeof(cliente));

    if (novo_cliente == NULL){
        printf("Memória insuficiente!\n");
        return NULL;
    }

    printf("\n--- CADASTRO DE CLIENTE ---\n");

    while(getchar() != '\n');

    printf("NOME: ");
    scanf(" %[^\n]", novo_cliente->nome);

    int cpf_valido = 0;
    do {
        printf("CPF (Apenas 11 numeros): ");
        scanf(" %[^\n]", novo_cliente->CPF);

        if (validar_cpf(novo_cliente->CPF)){
            cpf_valido = 1;
        } else {
            printf(">> ERRO: CPF inválido! Digite exatamente 11 numeros.\n");
        }
    } while (cpf_valido == 0);

    printf("EMAIL: ");
    scanf(" %[^\n]", novo_cliente->email);

    int telefone_valido = 0;
    do {
        printf("Numero (DDD + Telefone): ");
        scanf(" %[^\n]", novo_cliente->telefone);

        if (validar_telefone(novo_cliente->telefone)){
            telefone_valido = 1;
        } else {
            printf(">> ERRO: Telefone inválido! Digite exatamente 11 numeros.\n");
        }
    } while (telefone_valido == 0);


    int data_valida = 0;
    do {
        printf("DATA DE NASCIMENTO (DD/MM/AAAA): ");
        scanf(" %[^\n]", novo_cliente->data_de_nascimento);

        if (validar_data(novo_cliente->data_de_nascimento)){
            data_valida = 1;
        } else {
            printf(">> ERRO: Formato invalido ! (XX/XX/XXXX).\n");
        }

    } while (data_valida == 0);

    novo_cliente->prox = NULL;
    novo_cliente->carrinho = NULL;

    return novo_cliente;
}

void cadastrar_cliente(cliente **inicio){
    cliente* novo_cliente = criar_cliente();

    if (novo_cliente == NULL){
        return;
    }

    if (*inicio == NULL){
        *inicio = novo_cliente;
    } 
    else{
        cliente *aux = *inicio;

        while (aux->prox != NULL){
            aux = aux->prox;
        }

        aux->prox = novo_cliente;
    }

    printf("\n--- Cliente %s cadastrado(a) com sucesso! ---\n", novo_cliente->nome);
    salvar_cliente_sql(novo_cliente);
}

cliente* inicializar_lista_cliente(){
    return NULL;
}

void listar_clientes(cliente *inicio){
    if (inicio == NULL){
        printf("\nNenhum cliente cadastrado, a lista está vazia!\n");
        return;
    }

    printf("\n--- LISTA DE CLIENTES ---\n");

    cliente *atual = inicio; //var auxiliar p nao perder o inicio

    while(atual != NULL){
        printf("Nome: %s | CPF: %.3s.%.3s.%.3s-%.2s\n", atual->nome, atual->CPF, atual->CPF + 3, atual->CPF +6, atual->CPF + 9);
        
        int tam_tel = strlen(atual->telefone);
        
        if (tam_tel == 11){
            printf("Email: %s | Telefone: (%.2s) %.5s-%.4s\n", atual->email, atual->telefone, atual ->telefone +2, atual->telefone +7);
        } else {
            printf("Email: %s | Telefone: (%.2s) %.4s-%.4s\n", atual -> email, atual->telefone, atual->telefone + 2, atual->telefone+6);
        }
        printf("--------------------------------------------------\n");

        atual = atual->prox;
    }
}

cliente* buscar_cliente(cliente *inicio, char *cpf_busca){
    cliente *atual = inicio;

    while (atual != NULL){
        if (strcmp(atual->CPF, cpf_busca) == 0){
            return atual;
        }
        atual = atual->prox;
    }
    return NULL;
}

void editar_cliente(cliente *inicio){
    char cpf_busca[14];
    printf("\n--- EDITAR CADASTRO COMPLETO ---\n");
    printf("Digite o CPF ATUAL do cliente para encontrar: ");
    scanf(" %[^\n]", cpf_busca);

    cliente *encontrado = buscar_cliente(inicio, cpf_busca);

    if (encontrado == NULL){
        printf("Nenhum cliente encontrado com o CPF %s.\n", cpf_busca);
        return;
    }

    char cpf_velho[14];
    strcpy(cpf_velho, encontrado->CPF);

    printf("\nEditando dados de: %s", encontrado->nome);
    char r;

    printf("\nDeseja editar o NOME ? (S/N): ");
    scanf(" %c", &r);

    if (r == 'S' || r == 's'){
        printf("Novo Nome: ");
        scanf(" %[^\n]", encontrado->nome); 
    }

    printf("\nDeseja editar o CPF? (S/N): ");
    scanf(" %c", &r); 

    if (r == 'S' || r == 's') {
        printf("Novo CPF: ");
        scanf(" %[^\n]", encontrado->CPF);
    }

    printf("\nDeseja editar o EMAIL? (S/N): ");
    scanf(" %c", &r); 

    if (r == 'S' || r == 's') {
        printf("Novo Email: ");
        scanf(" %[^\n]", encontrado->email);
    }

    printf("\nDeseja editar o TELEFONE? (S/N): ");
    scanf(" %c", &r); 

    if (r == 'S' || r == 's') {
        printf("Novo Telefone: ");
        scanf(" %[^\n]", encontrado->telefone);
    }

    printf("\nDeseja editar a DATA DE NASCIMENTO? (S/N): ");
    scanf(" %c", &r); 

    if (r == 'S' || r == 's') {
        printf("Nova Data: ");
        scanf(" %[^\n]", encontrado->data_de_nascimento);
    }

    printf("\n--- Edicao concluida! ---\n");
    atualizar_cliente_sql(encontrado, cpf_velho);
}

void ver_carrinho_cliente(cliente *c){
    if (c->carrinho == NULL){
        printf("\nCarrinho vazio.\n");
        return;
    }

    printf("\n--- CARRINHO DE %s ---\n", c->nome);

    produto *p = (produto*) c->carrinho;
    float total = 0;

    while (p != NULL){
        float sub = p-> preco * p->quantidade;
        printf("- %dx %s (R$ %.2f) = R$ %.2f\n", p->quantidade, p->nome, p->preco, sub);
        total += sub;
        p = p->prox;
    }
    printf("-------------------------\n");
    printf("TOTAL: R$ %.2f\n", total);

}

void limpar_carrinho_cliente(cliente *c){
    if (c->carrinho == NULL){
        return;
    }

    produto *p = (produto*) c->carrinho;

    while(p != NULL){
        produto *temp = p;
        p = p->prox;
        free(temp);
    }
    c -> carrinho = NULL;
}

void remover_cliente(cliente **inicio){
    char cpf_deletado[14];
    printf("\n--- REMOVER CLIENTE ---\n");
    printf("Digite o CPF para remover: ");
    scanf(" %[^\n]", cpf_deletado);

    cliente *anterior = NULL;
    cliente *atual = *inicio;

    while (atual != NULL && strcmp(atual->CPF, cpf_deletado) != 0){
        anterior = atual;
        atual = atual->prox;
    }

    if(atual == NULL){
        printf("\nCliente não encontrado.\n");
        return;
    }

    if (anterior == NULL){ //alvo é o primeiro da lista
        *inicio = atual->prox; //inicio agora é o 2do
    } else { //alvo no meio ou fim
        anterior->prox = atual->prox; //anterior aponta p prox;
    }

    remover_cliente_sql(cpf_deletado);
    limpar_carrinho_cliente(atual);
    free(atual);
    printf("--- Cliente removido com sucesso ---");
}
==> cliente.h <==
#ifndef CLIENTE_H
#define CLIENTE_H

#include <stdio.h>
#include <stdlib.h>

typedef struct Cliente{
    char CPF[14];
    char nome[100];
    char email[100];
    char telefone[100];
    char data_de_nascimento[11];

    void *carrinho; //ponteiro p carrinho 
    struct Cliente *prox; //ponteiro p proximo cliente: lista encadeada

} cliente; 

void menu_clientes(cliente **inicio);

int validar_cpf(char *cpf);

cliente* criar_cliente();

void cadastrar_cliente(cliente **inicio);

cliente* inicializar_lista_cliente();

void listar_clientes(cliente *inicio);

cliente* buscar_cliente(cliente *inicio,                     char *cpf_busca);

void editar_cliente(cliente *inicio);

void ver_carrinho_cliente(cliente *c);

void remover_cliente(cliente **inicio);

#endif
==> main.c <==
#include <stdio.h>
#include <stdlib.h>
#include <ctype.h>
#include <locale.h>

#include "cliente.h"
#include "produto.h"
#include "modo_compra.h"
#include "banco.h"

#ifdef _WIN32
    #include <windows.h>
#endif

int main(){
    #ifdef _WIN32
        SetConsoleOutputCP(65001);
    #else
        setlocale(LC_ALL, "C.UTF-8");
    #endif

    inicializar_banco();
    produto *lista_de_produtos = carregar_produtos_do_sql();
    cliente *lista_de_clientes = carregar_clientes_do_sql();

    int opcao;

    do{
        printf("\n=== HLH ESPORTES ===\n");
        printf("1. Gestão dos Clientes\n");
        printf("2. Gestão dos Produtos\n");
        printf("3. Modo Compra\n");
        printf("4. Histórico Geral de Vendas\n");
        printf("0. Sair\n");

        printf("\nEscolha uma opção: ");
        scanf("%d", &opcao);

        switch(opcao){
            case 0:
                printf("\nEncerrando o sistema...\n");
                break;

            case 1:
                menu_clientes(&lista_de_clientes);
                break;

            case 2:
                {
                    int op_prod;
                    do{
                        printf("\n--- GESTAO DE ESTOQUE ---\n");
                        printf("1. Cadastrar Produto\n");
                        printf("2. Listar Estoque\n");
                        printf("3. Editar Produto\n");
                        printf("4. Remover Produto\n");
                        printf("0. Voltar\n");
                        printf("Escolha: ");
                        scanf("%d", &op_prod);

                        int cod, qtd;
                        float preco;
                        char nome[50];  

                        switch(op_prod){
                            case 1:

                                char buffer_cod[50];
                                int cod_valido = 0;

                                do {
                                    printf("Codigo: ");
                                    scanf(" %s", buffer_cod);

                                    cod_valido = 1;
                                    for (int i=0; buffer_cod[i] != '\0'; i++){
                                        if (!isdigit(buffer_cod[i])){
                                            cod_valido = 0;
                                            break;
                                        }
                                    }
                                    
                                    if(!cod_valido){
                                        printf("Erro: O codigo deve conter APENAS inteiros positivos. Tente novamente.\n");
                                    }

                                }while(!cod_valido);

                                cod = atoi(buffer_cod);

                                printf("Nome: "); scanf(" %[^\n]", nome);
                                printf("Preco: "); scanf("%f", &preco);
                                printf("Qtd Inicial: "); scanf("%d", &qtd);

                                int cat = 0;
                                do {
                                    printf("Categoria (1-Futebol, 2-Basquete): ");
                                    scanf("%d", &cat);
                                } while (cat != 1 && cat != 2);


                                lista_de_produtos = adicionar_produto(lista_de_produtos, cod, nome, preco, qtd, cat);
                                printf("Produto cadastrado!\n");
                                break;
                            case 2:
                                printf("\n--- Estoque Atual ---\n");
                                listar_produtos(lista_de_produtos);
                                break;
                            case 3:
                                printf("Codigo para editar: "); scanf("%d", &cod);
                                editar_produto(lista_de_produtos, cod);
                                break;
                            case 4:
                                printf("Codigo para remover: "); scanf("%d", &cod);
                                lista_de_produtos = remover_produto(lista_de_produtos, cod);
                                break;
                        }                      
                    }while (op_prod != 0);
                }
                break;

            case 3:
                {
                    char cpf_login[14];
                    printf("\n--- LOGIN NO CAIXA ---\n");
                    printf("Digite o CPF do cliente: ");
                    scanf(" %[^\n]", cpf_login);

                    cliente *cliente_atual = buscar_cliente(lista_de_clientes, cpf_login);

                    if (cliente_atual == NULL) {
                        printf("ERRO: Cliente nao encontrado. Cadastre-o no menu 1 antes de comprar.\n");
                    } else {
                        iniciar_modo_compra(lista_de_produtos, cliente_atual);
                    }
                }
                break;

            case 4:
                listar_historico_geral_sql();
                break;
            
            default:
                printf("\nOpcao invalida! Tente novamente.\n");
        }
    } while (opcao != 0);

    return 0;
}
==> modo_compra.c <==
#include <stdio.h>
#include <string.h>
#include <stdlib.h>

#include "modo_compra.h"
#include "produto.h"
#include "cliente.h"
#include "banco.h"

float calcular_total_carrinho(produto *carrinho){
    float total = 0;
    produto *p = carrinho;
    while (p != NULL){
        total += p -> preco * p -> quantidade; //o ponteiro acessa preço e quantidade do produto e multiplica os dois
        p = p-> prox;
    }
    return total;
}

void limpar_carrinho(produto *carrinho){
    produto *atual = carrinho;
    while (atual != NULL){
        produto *temp = atual;
        atual = atual->prox;
        free(temp);
    }
}

void devolver_estoque(produto *carrinho, produto *estoque_oficial){
    produto *p = carrinho;
    while (p != NULL){
        produto *produto_estoque = buscar_produto(estoque_oficial, p->codigo);

        if(produto_estoque != NULL) produto_estoque -> quantidade += p->quantidade;
    
        p = p->prox;
    }

}

void iniciar_modo_compra(produto *estoque, cliente *comprador){

    produto *carrinho = (produto*) comprador->carrinho; //inicia carrinho como uma lista vazia

    int opcao = 0;
    int codigo_digitado;
    int qtd_desejada;

    do{
        printf("\n=== CAIXA LIVRE / MODO COMPRA ===\n");
        printf("1. Ver Estoque\n");
        printf("2. Colocar Produto no Carrinho\n");
        printf("3. Ver Meu Carrinho\n");
        printf("4. Finalizar Compra\n");
        printf("5. Cancelar compra (esvaziar o carrinho)\n");
        printf("6. Salvar e voltar (manter os itens no carrinho)\n");
        printf("Escolha: ");
        scanf("%d", &opcao);

        switch(opcao){
            case 1:
                printf("\n--- Produtos Disponíveis---\n");
                listar_produtos(estoque);
                break;

            case 2:
                printf("\n--- CONSULTE A LISTA DE PRODUTOS ---\n");
                listar_produtos(estoque); 
                printf("----------------------------------------\n");
                
                printf("Digite o código do produto: ");
                scanf("%d", &codigo_digitado);

                produto *item_no_estoque = buscar_produto(estoque, codigo_digitado);

                if(item_no_estoque == NULL){
                    printf("Produto não encontrado");
                }
                else{
                    printf("Item: %s | Preco: R$ %.2f | Estoque: %d\n", item_no_estoque-> nome, item_no_estoque->preco, item_no_estoque->quantidade);
                    
                    printf("Quantas unidades você deseja? ");
                    scanf("%d", &qtd_desejada);

                    if(qtd_desejada > item_no_estoque->quantidade) printf("Erro: Quantidade maior que a disponível em estoque\n");
                    else if(qtd_desejada <= 0){
                        printf("Quantidade invalida\n");
                    }
                    else{
                        //o carrinho é uma lista de produtos, então podemos usar as mesmas funções de produto
                        carrinho = adicionar_produto(carrinho, item_no_estoque->codigo, item_no_estoque->nome, item_no_estoque->preco, qtd_desejada, item_no_estoque->categoria);

                        item_no_estoque->quantidade -= qtd_desejada; //dá baixa no estoque
                        printf("Produto adicionado ao carrinho\n");                    
                    }
                }
                break;

            case 3:
                printf("\n--- Carrinho de Compras ---\n");
                if (carrinho == NULL) {
                    printf("Seu carrinho esta vazio.\n");
                } else {
                    listar_produtos(carrinho);
                    printf("---------------------------\n");
                    printf("Subtotal: R$ %.2f\n", calcular_total_carrinho(carrinho));
                }
                break;

            case 4:
                if (carrinho == NULL) {
                    printf("Carrinho vazio. Nada para pagar.\n");
                } else {
                    float total = calcular_total_carrinho(carrinho);
                    printf("\n=== CUPOM FISCAL ===\n");
                    listar_produtos(carrinho);
                    printf("====================\n");
                    printf("TOTAL A PAGAR: R$ %.2f\n", total);
                    salvar_venda_sql(comprador->CPF, comprador->nome, carrinho);
                    produto *p_temp = carrinho;
                    while(p_temp != NULL){
                        produto *original = buscar_produto(estoque, p_temp->codigo);
                        if(original) atualizar_produto_sql(original, original->codigo);
                        p_temp = p_temp->prox;
                    }
                    printf("Obrigado pela compra!\n");
                    limpar_carrinho(carrinho);
                    carrinho = NULL;
                    comprador->carrinho = NULL;
                    
                    return; 
                }
                break;

            case 5:
                if (carrinho != NULL){
                    printf("Devolvendo itens para as prateleiras\n");
                    devolver_estoque(carrinho, estoque);

                    limpar_carrinho(carrinho);
                    carrinho = NULL;
                    comprador->carrinho = NULL;
                }
                printf("Compra cancelada.\n");
                return;
            
            case 6:
                printf("Salvando seu carrinho para mais tarde.\n");
                comprador->carrinho = (void*) carrinho;
        }

    }while (opcao != 6);

}
==> modo_compra.h <==
#ifndef MODO_COMPRA_H
#define MODO_COMPRA_H

#include "produto.h"
#include "cliente.h"

void iniciar_modo_compra(produto *estoque, cliente *comprador);

#endif
==> produto.c <==
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include "produto.h"

produto *adicionar_produto(produto *lista, int codigo, char *nome, float preco, int quantidade, int categoria){
    produto *novo_produto = (produto*) malloc(sizeof(produto));

    if (novo_produto == NULL){
        printf("Erro: Memoria cheia!\n");
        exit(1);
    }

    novo_produto->codigo = codigo;
    novo_produto->preco = preco;
    novo_produto->quantidade = quantidade;
    novo_produto->categoria = categoria;
    strcpy(novo_produto->nome, nome);

    novo_produto->prox = lista;
    salvar_produto_sql(novo_produto);
    return novo_produto;
}

void listar_produtos(produto *lista){
    if (lista == NULL){
        printf("lista vazia!\n");
        return;
    }

    printf("\n========= FUTEBOL =========\n");
    produto *p = lista;
    while(p != NULL){
        if (p->categoria == 1){
            printf("Cod: %d | %s | R$ %.2f | Qtd: %d\n", p->codigo, p->nome, p->preco, p->quantidade);
        }
        p = p->prox;
    }

    printf("\n========= BASQUETE =========\n");
    p = lista;
    while(p != NULL){
        if (p -> categoria == 2){
            printf("Cod: %d | %s | R$%.2f | Qtd: %d\n", p->codigo, p->nome, p->preco, p->quantidade);
        }
        p = p->prox;
    }
}

produto *buscar_produto(produto *lista, int codigo){
    produto *p = lista;

    while(p != NULL){
        if(p->codigo == codigo) return p;
        p = p->prox;
    }

    return NULL;
}

void editar_produto(produto *lista, int codigo){
    produto *p = buscar_produto(lista, codigo);

    if(p == NULL){
        printf("Produto %d não encontrado\n", codigo);
        return;
    }

    int codigo_velho = p->codigo;

    printf("Editando: %s (Preço atual: %.2f | Quantidade: %d)", p->nome, p->preco, p->quantidade);

    printf("Digite o novo preço: ");
    scanf("%f", &p->preco);

    printf("Digite a nova quantidade: ");
    scanf("%d", &p->quantidade);

    printf("Dados atualizados com sucesso!\n");
    atualizar_produto_sql(p, codigo_velho);
}

produto *remover_produto(produto *lista, int codigo){
    produto *atual = lista;
    produto *anterior = NULL;

    while (atual != NULL && atual->codigo != codigo){
        anterior = atual;
        atual = atual->prox;
    }

    if(atual == NULL){ // percorreu td e não achou
        printf("Produto não encontrado para remoção.\n");
        return lista;
    }

    if (anterior == NULL){ // já é o primeiro
        produto *nova_cabeca = atual->prox;
        free(atual);
        return nova_cabeca;
    } 

    anterior->prox = atual->prox;// o anterior passa a apontar para o depois do atual
    remover_produto_sql(codigo);
    free(atual);
    
    return lista;
}


==> produto.h <==
#ifndef PRODUTO_H
#define PRODUTO_H

typedef struct Produto{
    int codigo;
    char nome[50];
    float preco;
    int quantidade;
    int categoria;
    struct Produto *prox; //cria um ponteiro do tipo 'Produto' pra apontar pro próximo da lista
} produto;

produto *adicionar_produto(produto *lista, int codigo, char *nome, float preco, int quantidade, int categoria);

void listar_produtos(produto *lista);

produto *buscar_produto(produto *lista, int codigo);

produto *remover_produto(produto *lista, int codigo);

void editar_produto(produto *lista, int codigo_busca);


#endif
